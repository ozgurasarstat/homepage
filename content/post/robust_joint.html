---
title: "Robust Joint Models"
author: "Özgür Asar"
date: 2019-07-17
categories: ["R"]
tags: ["joint models", "regression"]
---



<div id="robust-joint-modelling-framework" class="section level2">
<h2>Robust Joint Modelling Framework</h2>
<p>Joint modelling of longitudinal time-to-event outcomes typically
combines a linear mixed-effects model and a Cox model (<a href="https://academic.oup.com/ije/article/44/1/334/657852">Asar et al., 2015</a>).
Typical distributional assumption is that random-effects and
measurement error terms in mixed-effects model are Gaussian.
However, this assumption might not be restricive for real-life
problems where it is quite likely to have subjects who do not
conform the population averaged trends (they are examples of
outliers in the random-effects), and subjects who has a few
observations that are quite different compared to the rest
of the observations for subjects’ own collection of measurements
(they are examples of outliers in measurement error).
Gaussian distribution would not give appropriate weights to the outliers,
hence inference might be biased and inefficient, and personalised predictions might be
misleading. A natural approach would be to replace the Gaussian assumption
with t distribution. Technical details of joint models with t distributions are
skipped here, and interested reader is referred to <a href="https://arxiv.org/abs/1905.00816">Asar, Fournier and Dantan (2019)</a>.</p>
</div>
<div id="implementation" class="section level2">
<h2>Implementation</h2>
<p>We describe the
R package <a href="https://github.com/ozgurasarstat/robjm"><code>robjm</code></a> to implement the
joint models with Gaussian and t distributed random-effects and subsequently
to obtain personalised dynamic predictions. For illustration, we will use the
AIDS data-set, where biomarker of interest is the CD4 cell counts, and the
survival event is death.</p>
<p><code>robjm</code> is still under development, hence is currently only available from Github.
Note that <code>robjm</code> internatlly calls <code>tidyverse</code> and <code>rstan</code> packages.
To install it from Github and load into the working environment,
use the following lines of code:</p>
<pre class="r"><code>devtools::install_github(&quot;ozgurasarstat/robjm&quot;, quiet = TRUE)
suppressMessages(library(robjm))</code></pre>
<p>AIDS data-set can be loaded by</p>
<pre class="r"><code>data(aids)
data(aids.id)

aids$drug2 &lt;- ifelse(aids$drug == &quot;ddC&quot;, 0, 1)
aids.id$drug2 &lt;- ifelse(aids.id$drug == &quot;ddC&quot;, 0, 1)

id_first_100 &lt;- aids.id$patient[1:100]

long_data &lt;- aids[aids$patient %in% id_first_100, ]
surv_data &lt;- aids.id[aids.id$patient %in% id_first_100, ]

## normal normal model
fit_nor_nor &lt;- fit_jm(fixed_long = CD4 ~ obstime, 
                      random_long = ~ obstime, 
                      fixed_surv = cbind(Time, death) ~ drug2, 
                      data_long = long_data,
                      data_surv = surv_data,
                      id_long = &quot;patient&quot;,
                      id_surv = &quot;patient&quot;,
                      model = &quot;nor_nor&quot;,
                      timeVar = &quot;obstime&quot;,
                      bh = &quot;weibull&quot;,
                      chains = 2,
                      cores = 2,
                      iter = 2000,
                      warmup = 1000,
                      control = list(adapt_delta = 0.8, max_treedepth = 10) 
                      )
## Warning: There were 12 divergent transitions after warmup. Increasing adapt_delta above 0.8 may help. See
## http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
## Warning: Examine the pairs() plot to diagnose sampling problems
## Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
## Running the chains for more iterations may help. See
## http://mc-stan.org/misc/warnings.html#bulk-ess
## Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
## Running the chains for more iterations may help. See
## http://mc-stan.org/misc/warnings.html#tail-ess
#print(fit_nor_nor, pars = c(&quot;alpha&quot;, &quot;Sigma&quot;, &quot;sigmasq&quot;, &quot;lambda&quot;, &quot;nu&quot;, &quot;omega&quot;, &quot;eta&quot;))
#traceplot(fit_nor_nor, 
#          pars = c(&quot;alpha&quot;, &quot;Sigma&quot;, &quot;sigmasq&quot;, &quot;zeta&quot;, &quot;omega&quot;, &quot;eta&quot;),
#          inc_warmup = FALSE)</code></pre>
<p>To be able to fit the joint model, we also need a baseline extract from
<code>aids</code>:</p>
<pre class="r"><code>aids_base &lt;- dplyr::filter(aids, obstime == 0) </code></pre>
</div>
