---
title: "Robust Joint Models"
author: "Özgür Asar"
date: 2019-07-17
categories: ["R"]
tags: ["joint models", "regression"]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE)
```

## Robust Joint Modelling Framework

Joint modelling of longitudinal time-to-event outcomes typically 
combines a linear mixed-effects model and a Cox model ([Asar et al., 2015](https://academic.oup.com/ije/article/44/1/334/657852)). 
Typical distributional assumption is that random-effects and 
measurement error terms in mixed-effects model are Gaussian. 
However, this assumption might not be restricive for real-life 
problems where it is quite likely to have subjects who do not 
conform the population averaged trends (they are examples of 
outliers in the random-effects), and subjects who has a few 
observations that are quite different compared to the rest 
of the observations for subjects' own collection of measurements 
(they are examples of outliers in measurement error). 
Gaussian distribution would not give appropriate weights to the outliers, 
hence inference might be biased and inefficient, and personalised predictions might be 
misleading. A natural approach would be to replace the Gaussian assumption 
with t distribution. Technical details of joint models with t distributions are 
skipped here, and interested reader is referred to [Asar, Fournier and Dantan (2019)](https://arxiv.org/abs/1905.00816). 

## Implementation

We describe the 
R package [`robjm`](https://github.com/ozgurasarstat/robjm) to implement the 
joint models with Gaussian and t distributed random-effects and subsequently 
to obtain personalised dynamic predictions. For illustration, we will use the 
AIDS data-set, where biomarker of interest is the CD4 cell counts, and the 
survival event is death. 

`robjm` is still under development, hence is currently only available from Github. 
Note that `robjm` internatlly calls `tidyverse` and `rstan` packages. 
To install it from Github and load into the working environment, 
use the following lines of code:
```{r cars}
devtools::install_github("ozgurasarstat/robjm", quiet = TRUE)
suppressMessages(library(robjm))
```
AIDS data-set can be loaded by
```{r}
data(aids)
data(aids.id)

aids$drug2 <- ifelse(aids$drug == "ddC", 0, 1)
aids.id$drug2 <- ifelse(aids.id$drug == "ddC", 0, 1)

id_first_100 <- aids.id$patient[1:100]

long_data <- aids[aids$patient %in% id_first_100, ]
surv_data <- aids.id[aids.id$patient %in% id_first_100, ]

## normal normal model
fit_nor_nor <- fit_jm(fixed_long = CD4 ~ obstime, 
                      random_long = ~ obstime, 
                      fixed_surv = cbind(Time, death) ~ drug2, 
                      data_long = long_data,
                      data_surv = surv_data,
                      id_long = "patient",
                      id_surv = "patient",
                      model = "nor_nor",
                      timeVar = "obstime",
                      bh = "weibull",
                      chains = 2,
                      cores = 2,
                      iter = 2000,
                      warmup = 1000,
                      control = list(adapt_delta = 0.8, max_treedepth = 10) 
                      )
```
```{r}
print(fit_nor_nor, 
      pars = c("alpha", "Sigma", "sigmasq", "lambda", "nu", "omega", "eta"))
traceplot(fit_nor_nor, 
          pars = c("alpha", "Sigma", "sigmasq", "lambda", "nu", "omega", "eta"),
          inc_warmup = FALSE)
```
To be able to fit the joint model, we also need a baseline extract from 
`aids`:
```{r}
aids_base <- dplyr::filter(aids, obstime == 0) 
```

